#!/usr/bin/env bash
# Returns the latest stable PostgreSQL version without fetching full version list
# This optimization is called by mise when installing postgres-binary:postgres@latest
#
# Performance: Single API call vs paginated full list (200+ versions)
# Fallback: If this fails, mise will call BackendListVersions() instead

set -euo pipefail

# Get latest release (non-prerelease) from GitHub API
# Uses GitHub token if available to avoid rate limits
GITHUB_API_URL="https://api.github.com/repos/theseus-rs/postgresql-binaries/releases/latest"

# Build curl command with optional authentication
CURL_ARGS=(-sSL)
if [[ -n "${GITHUB_TOKEN:-}" ]]; then
    CURL_ARGS+=(-H "Authorization: Bearer $GITHUB_TOKEN")
elif [[ -n "${GH_TOKEN:-}" ]]; then
    CURL_ARGS+=(-H "Authorization: Bearer $GH_TOKEN")
fi

# Fetch latest release and extract tag_name
LATEST_VERSION=$(curl "${CURL_ARGS[@]}" "$GITHUB_API_URL" | grep -o '"tag_name": "[^"]*"' | cut -d'"' -f4)

if [[ -z "$LATEST_VERSION" ]]; then
    echo "ERROR: Failed to fetch latest PostgreSQL version" >&2
    exit 1
fi

echo "$LATEST_VERSION"
