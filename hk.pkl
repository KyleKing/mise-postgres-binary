/// hk configuration for linting and pre-commit hooks
/// https://github.com/jdx/hk
amends "package://github.com/jdx/hk/releases/download/v1.34.0/hk@1.34.0#/Config.pkl"

import "package://github.com/jdx/hk/releases/download/v1.34.0/hk@1.34.0#/Builtins.pkl"

/// Global configuration
jobs = 0  // Auto-detect number of parallel jobs
fail_fast = true  // Abort on first failure for faster feedback
exclude = List("**/.luarocks/**", "**/luacov.*")

/// Linter definitions
/// Note: check_first disabled due to implementation limitations in hk 1.34.0
local linters = new Mapping<String, Step> {
    ["actionlint"] = (Builtins.actionlint) { check_first = false }
    ["byte-order-marker"] = (Builtins.byte_order_marker) { check_first = false }
    ["check-added-large-files"] = (Builtins.check_added_large_files) { check_first = false }
    ["check-executables-have-shebangs"] = (Builtins.check_executables_have_shebangs) { check_first = false }
    ["check-merge-conflict"] = (Builtins.check_merge_conflict) { check_first = false }
    ["check-symlinks"] = (Builtins.check_symlinks) { check_first = false }
    ["detect-private-key"] = (Builtins.detect_private_key) { check_first = false }
    ["jq"] = (Builtins.jq) { check_first = false }
    ["mixed-line-ending"] = (Builtins.mixed_line_ending) { check_first = false }
    ["newlines"] = (Builtins.newlines) { check_first = false }
    ["ruff"] = (Builtins.ruff) { check_first = false }
    ["selene"] = (Builtins.selene) { check_first = false }
    ["stylua"] = (Builtins.stylua) { check_first = false }
    ["toml-sort"] {
        glob = List("**/*.toml")
        check = "toml-sort --check {{ files }}"
        fix = "toml-sort --in-place {{ files }}"
        check_first = false
    }
    ["trailing-whitespace"] = (Builtins.trailing_whitespace) { check_first = false }
}

/// Hook definitions
hooks {
    ["pre-commit"] {
        fix = true  // Auto-fix issues when possible
        stash = "git"  // Stash unstaged changes during hook execution
        stage = true  // Auto-stage fixed files
        steps = linters
    }
    ["pre-push"] {
        steps = linters  // Run checks before pushing
    }
    ["fix"] {
        fix = true  // Manual fix command
        steps = linters
    }
    ["check"] {
        steps = linters  // Manual check command (read-only)
    }
}
