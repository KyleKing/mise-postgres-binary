# Dockerfile for testing mise-postgres-binary on Alpine (musl)
FROM alpine:3.20

ARG POSTGRES_VERSION=14.20.0
ARG GITHUB_TOKEN

# Install minimal dependencies + PostgreSQL runtime dependencies
RUN apk add --no-cache \
    bash \
    ca-certificates \
    curl \
    icu-libs \
    krb5-libs \
    libxml2 \
    lz4-libs \
    readline

# Create non-root user for PostgreSQL (initdb refuses to run as root)
RUN adduser -D -s /bin/bash postgres

# Switch to postgres user for mise installation and testing
USER postgres
WORKDIR /home/postgres

# Install mise as postgres user
RUN curl https://mise.run | sh
ENV PATH="/home/postgres/.local/bin:$PATH"
ENV GITHUB_TOKEN=${GITHUB_TOKEN}

# Create plugin directory and copy plugin files
RUN mkdir -p /home/postgres/plugin
WORKDIR /home/postgres/plugin
COPY --chown=postgres:postgres . .

# Link the plugin and configure mise
RUN mise trust \
    && mise settings set experimental true \
    && mise plugin link --force postgres-binary /home/postgres/plugin

# Test script
RUN printf '#!/bin/bash\n\
set -euo pipefail\n\
echo "=== Testing mise-postgres-binary on Alpine (musl) ==="\n\
echo "Platform: $(uname -s) $(uname -m)"\n\
echo "libc: musl"\n\
echo ""\n\
echo "Step 1: List available versions"\n\
mise ls-remote postgres-binary:postgres | head -5\n\
echo ""\n\
echo "Step 2: Install PostgreSQL %s"\n\
mise install postgres-binary:postgres@%s\n\
echo ""\n\
echo "Step 3: Verify installation"\n\
mise exec postgres-binary:postgres@%s -- postgres --version\n\
mise exec postgres-binary:postgres@%s -- psql --version\n\
mise exec postgres-binary:postgres@%s -- pg_dump --version\n\
echo ""\n\
echo "Step 4: Check environment"\n\
mise use postgres-binary:postgres@%s\n\
eval "$(mise activate bash)"\n\
echo "PGDATA=$PGDATA"\n\
[ -d "$PGDATA" ] && echo "PGDATA directory exists" || exit 1\n\
[ -f "$PGDATA/PG_VERSION" ] && echo "Database initialized (PG_VERSION present)" || exit 1\n\
echo ""\n\
echo "Step 5: Start PostgreSQL briefly"\n\
pg_ctl start -D "$PGDATA" -l /tmp/pg.log -w\n\
sleep 2\n\
psql -c "SELECT version();" postgres\n\
pg_ctl stop -D "$PGDATA" -m fast\n\
echo ""\n\
echo "=== All tests passed ==="\n' "${POSTGRES_VERSION}" "${POSTGRES_VERSION}" "${POSTGRES_VERSION}" "${POSTGRES_VERSION}" "${POSTGRES_VERSION}" "${POSTGRES_VERSION}" > /home/postgres/test.sh \
    && chmod +x /home/postgres/test.sh

CMD ["/home/postgres/test.sh"]
